#!/usr/bin/env node
const pkg = require('../package.json')
const path = require('path')
const { directories } = require('../config.json')
const { outputFile } = require('fs-promise')
const nunjucks = require('nunjucks')
const debug = require('debug')(`${pkg.name}:build:html`)

const { NODE_ENV } = process.env
const environment = nunjucks.configure(
	path.resolve(`${directories.sourceFiles}/markup`),
	{ watch: NODE_ENV === 'development' }
)

/**
 * Renders the HTML views via nunjucks.
 * @param {String} renderPath
 * @return {Promise}
 */
function renderHTML (renderPath = './index.html') {
	return new Promise((resolve, reject) => {
		environment.render(renderPath, (error, response) => {
			if (error) reject(error)
			resolve(response)
		})
	})
}

module.exports = (message = 'building HTML files') => {
	debug(message)
	return renderHTML('./index.html')
		.then(file => outputFile(`${directories.dist}/index.html`, file, 'utf8'))
		.catch(debug)
}
